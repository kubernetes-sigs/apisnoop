# -*- ii: enabled; -*-
#+TITLE: Migrating to AWS using flux
#+PROPERTY: header-args:tmate+  :session flux
#+PROPERTY: header-args:tmate+  :window deploy
#+PROPERTY: header-args:shell+  :var FLUX_FORWARD_NAMESPACE="flux"
#+PROPERTY: header-args:shell+  :prologue "export FLUX_FORWARD_NAMESPACE"
* aws / eksctl cli
** install
   #+begin_src tmate
     brew tap weaveworks/tap
     brew install weaveworks/tap/eksctl
   #+end_src
** eksctl
*** help
    #+begin_src shell
      eksctl help
    #+end_src

    #+RESULTS:
    #+begin_example
    The official CLI for Amazon EKS

    Usage: eksctl [command] [flags]

    Commands:
      eksctl create                  Create resource(s)
      eksctl get                     Get resource(s)
      eksctl update                  Update resource(s)
      eksctl upgrade                 Upgrade resource(s)
      eksctl delete                  Delete resource(s)
      eksctl set                     Set values
      eksctl unset                   Unset values
      eksctl scale                   Scale resources(s)
      eksctl drain                   Drain resource(s)
      eksctl utils                   Various utils
      eksctl completion              Generates shell completion scripts
      eksctl version                 Output the version of eksctl
      eksctl help                    Help about any command

    Common flags:
      -C, --color string   toggle colorized logs (valid options: true, false, fabulous) (default "true")
      -h, --help           help for this command
      -v, --verbose int    set log level, use 0 to silence, 4 for debugging and 5 for debugging with AWS debug logging (default 3)

    Use 'eksctl [command] --help' for more information about a command.

    #+end_example

*** create clusters
    #+begin_src yaml :tangle eks-cluster.yaml :comments no
      apiVersion: eksctl.io/v1alpha5
      kind: ClusterConfig

      metadata:
        name: apisnoop
        region: ap-southeast-2
        version: '1.15'

      nodeGroups:
        - name: bigs
          instanceType: m5d.24xlarge
          # instanceType: m5.large
          minSize: 1
          desiredCapacity: 2
          maxSize: 3
          volumeSize: 1000
          volumeType: gp2
          # volumeType: io1
          # volumeIOPS: 2000
          iam:
            withAddonPolicies:
              externalDNS: true
              certManager: true
              imageBuilder: true
              ebs: true
              albIngress: true
              cloudWatch: true
          ssh:
            # publicKeyPath: ~/.ssh/id_rsa-4096-20090605-ccc.pub
            publicKey: "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAgEAsUXHYuDzE6fs2KkCj91qSqpMXyxozb9gDKcx3mlh87hCegevld75gQAhujVYGRgJLsdf7W0/lX81clCRP1FjbaYYrPkVWGR291U6K5rkL9kZqd9dC0h9iCvFTKdKC7sA/uaolFPWav3QFWdEp3geNNuAm/NKSckUs9yGgr1inANQNsHFl0JFzU34D2Kt43rKA0Qz3kkDKCnXzl+wltIKq5f1SH1HDlv0hoLgikVwg5CLLKCsZ8IFuxur1pdb26uM0vtFp2LJUNad6hK8RsU6p/NeTtOLjbKGsLkqCgSvoPxCAIbFKWIRuAfGd6CrNc2kAD4qM45jAvI9dLuzbopVfhXS16F0i3EzL8/VWuCk7l2mYRdjHAy+9fJksx1zx2wfeEXSoSUX8/ROxpWZaDA8gLAxUrp/hqHU351QDDEdunMfmlrGc6ixyIaxMugRuNsNB4eY91mmbiljeoSCs1GFbVRhC8KejdKpo266hSDdS7f1sV9dnxVhHBhCxWzN7+mfk4KzpjEVFoDR73X8IUOLGFikORl918i86bH2uqJ5zZLvOA4a0BqaRIExmAi7wQrm4iLcDH3THMpvEuy4965JZz1uPJYtGBD/Zj1O2sMA8K6zvSB/8q86fe1VdwIJxOHh50HqAH1jPHHfkxIdrL4nBmvF9Pkzpg/OWlyVjqWmWj0= hh
      "

      # cloudWatch:
      #   clusterLogging:
      #     # enable specific types of cluster control plane logs
      #     enableTypes: ["api", "audit", "authenticator", "controllerManager", "scheduler"]
      #     # all supported types: "api", "audit", "authenticator", "controllerManager", "scheduler"
      #     # supported special values: "*" and "all"
    #+end_src
    #+begin_src tmate :session hh :window create
      eksctl create cluster --config-file eks-cluster.yaml
   #+end_src

    #+RESULTS:
    #+begin_src shell
    No clusters found
    #+end_src

*** get clusters
    #+begin_src shell
      eksctl get clusters
    #+end_src

    #+RESULTS:
    #+begin_example
    NAME		REGION
    apisnoop	ap-southeast-2
    #+end_example

*** delete cluster
    #+begin_src tmate
      eksctl delete cluster apisnoop-prod
    #+end_src

    #+RESULTS:
    #+begin_example
    NAME				REGION
    exciting-mongoose-1584470894	us-east-1
    #+end_example

** aws
   #+begin_src shell
     aws list-clusters
   #+end_src


   #+RESULTS:
   #+begin_example
   #+end_example

* flux
** flux-manifest.yaml
  #+name: generate k8s manifest for flux
  #+begin_src shell
    export USER=cncf # fork for your own fun
    export NAME="Flux for APISnoop"
    export EMAIL=cncf-ci@ii.coop
    export BRANCH=cncf-ci@ii.coop
            --git-branch=flux \
    export FLUX_FORWARD_NAMESPACE=flux
    fluxctl install \
            --namespace=${FLUX_FORWARD_NAMESPACE} \
            --manifest-generation=true \
            --git-branch=flux \
            --git-email=${EMAIL} \
            --git-label=flux \
            --git-path kustomize \
            --git-url=git@github.com:${USER}/apisnoop \
            --git-user="${NAME}" > flux-manifest.yaml
  #+end_src

Some minor changes were made to the yaml:

#+begin_src yaml
        - --git-poll-interval=150
        - --ci-skip
        - --ci-skip-message='[ci skip]'
        - --sync-garbage-collection=true
#+end_src

** deploy
  #+begin_src shell :dir "."
    # possibly editing before you run
    kubectl apply -f flux-manifest.yaml
  #+end_src

  #+RESULTS:
  #+begin_example
  serviceaccount/flux created
  clusterrole.rbac.authorization.k8s.io/flux created
  clusterrolebinding.rbac.authorization.k8s.io/flux created
  deployment.apps/flux created
  secret/flux-git-deploy created
  deployment.apps/memcached created
  service/memcached created
  #+end_example

** delpoyment status
  #+begin_src shell
    kubectl -n ${FLUX_FORWARD_NAMESPACE} rollout status deployment/flux
  #+end_src

  #+RESULTS:
  #+begin_example
  Waiting for deployment "flux" rollout to finish: 0 of 1 updated replicas are available...
  deployment "flux" successfully rolled out
  #+end_example

** ssh-pubkey for deployment
Put this into github as a deploy key for the repo in question and allow write:
https://github.com/cncf/apisnoop/settings/keys/new

  #+begin_src shell
    fluxctl identity
  #+end_src

  #+RESULTS:
  #+begin_example
  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDf12Aqb1ZOoi2S817dW19Jo+PcvprkXKinYyxcEjCvxH7jzcF/n5X+/lP4fom3uqp1VaZmmyWjanR7N4BlkQ6PgeHhzW1CsD0UXjzqzpajwp2DR0YgHNhDrswLAeUb4L0k+PHVvERvq7DLgpuH2Y6XfbthORSY07oHG0ThKeou0DtOp7ejuKllwBPzuhUmLF2Nx4nQOPXzIyB1M+DD0inMTlDiaI3tzrPMM2lXivXbDFZ5EA9vQAIqvKalVZHee/ttfyxzUX4x2Z20PQ0bojiohSft35kHpXDOf/nCpmPfpWaAr48m3uz8fdddiPgn2DJrHL2IYS1QEF2aTo6Kpk+IcubWN/1zmVCRwvb2USV4JHkxEuv/KHeJpcf8z+CWT96kHuD89+UHHxWs0Sqn1TFfERSMnbFjDqQcb+ijS7K/Osw3NOqWTAmGnYTur/u0bzVq/Jb/de3XdkNRfJdjP9W1W5OWxjjqZj0w8A7skBzPI4BWcNjorPnkMaQhel30ir8= root@flux-7484776998-t4r6x
  #+end_example

** force sync

You could push and wait for the sync to happen... or fluxctl sync

  #+begin_src shell
    fluxctl sync
  #+end_src
* ingress
* image building
  #+begin_src tmate :window image
    for APP in auditlogger webapp postgres hasura ; do
        cd ~/apisnoop/apps/$APP/app
        export IMAGE=raiinbow/$APP:v2020.04.08-2
        docker build -t $IMAGE .
        docker push $IMAGE
    done
  #+end_src
* Move Site
** dns records
*** apisnoop.cncf.io CNAMEs to apisnoop.ii.coop
#+name: apisnoop.cncf.io dns CNAMEs to IP
#+begin_src shell
  dig apisnoop.cncf.io | grep -v \; | sed '/^\s*$/d'
#+end_src

#+RESULTS: apisnoop.cncf.io dns CNAMEs to IP
#+begin_src shell
apisnoop.cncf.io.	115	IN	CNAME	apisnoop.ii.coop.
apisnoop.ii.coop.	25	IN	CNAME	apisnoop.cncf.ci.
apisnoop.cncf.ci.	25	IN	CNAME	www.apisnoop.io.
www.apisnoop.io.	116	IN	A	35.189.36.228
#+end_src
*** apisnoop.ii.coop CNAMEs to apisnoop.cncf.ci
#+name: apisnoop.ii.coop dns CNAMEs to IP
#+begin_src shell
  dig apisnoop.ii.coop | grep -v \; | sed '/^\s*$/d'
#+end_src

#+RESULTS: apisnoop.ii.coop dns CNAMEs to IP
#+begin_src shell
apisnoop.ii.coop.	59	IN	CNAME	apisnoop.cncf.ci.
apisnoop.cncf.ci.	59	IN	CNAME	www.apisnoop.io.
www.apisnoop.io.	299	IN	A	35.189.36.228
#+end_src

*** apisnoop.cncf.ci CNAMEs to www.apisnoop.io
#+name: apisnoop.cncf.ci dns CNAMEs to IP
#+begin_src shell
  dig apisnoop.cncf.ci | grep -v \; | sed '/^\s*$/d'
#+end_src

#+RESULTS: apisnoop.cncf.ci dns CNAMEs to IP
#+begin_src shell
apisnoop.cncf.ci.	59	IN	CNAME	www.apisnoop.io.
www.apisnoop.io.	299	IN	A	35.189.36.228
#+end_src

*** www.apisnoop.io A to 35.189.36.228
#+name: www.apisnoop.io dns CNAMEs to IP
#+begin_src shell
  dig www.apisnoop.io | grep -v \; | sed '/^\s*$/d'
#+end_src

#+RESULTS: www.apisnoop.io dns CNAMEs to IP
#+begin_src shell
www.apisnoop.io.	299	IN	A	35.189.36.228
#+end_src

#+RESULTS: apisnoop.cncf.ci dns CNAMEs to IP
#+begin_src shell
apisnoop.cncf.ci.	59	IN	CNAME	www.apisnoop.io.
www.apisnoop.io.	299	IN	A	35.189.36.228
#+end_src

** dns domains IPs
*** dns servers for cncf.io
#+name: cncf.io registrar
#+begin_src shell
  whois cncf.io | grep Name\ Server:
#+end_src

#+RESULTS: cncf.io registrar
#+begin_src shell
Name Server: NS2.DNSIMPLE.COM
Name Server: NS1.DNSIMPLE.COM
Name Server: NS3.DNSIMPLE.COM
Name Server: NS4.DNSIMPLE.COM
#+end_src

*** dns servers for ii.coop
#+name: ii.coop registrar
#+begin_src shell
  whois ii.coop | grep Name\ Server:
#+end_src

#+RESULTS: ii.coop registrar
#+begin_src shell
Name Server: NS4.DNSIMPLE.COM
Name Server: NS3.DNSIMPLE.COM
Name Server: NS2.DNSIMPLE.COM
Name Server: NS1.DNSIMPLE.COM
Name Server: ns4.dnsimple.com
Name Server: ns3.dnsimple.com
Name Server: ns2.dnsimple.com
Name Server: ns1.dnsimple.com
#+end_src

*** dns servers for cncf.ci
#+name: cncf.ci registrar
#+begin_src shell
  whois cncf.ci | grep Name\ Server:
#+end_src

#+RESULTS: cncf.ci registrar
#+begin_src shell
Name Server: ns1.dnsimple.com
Name Server: ns2.dnsimple.com
Name Server: ns3.dnsimple.com
Name Server: ns4.dnsimple.com
#+end_src

*** dns servers for apisnoop.io
#+name: apisnoop.io registrar
#+begin_src shell
  whois apisnoop.io | grep Name\ Server:
#+end_src

#+RESULTS: apisnoop.io registrar
#+begin_src shell
Name Server: NS-1646.AWSDNS-13.CO.UK
Name Server: NS-424.AWSDNS-53.COM
Name Server: NS-878.AWSDNS-45.NET
Name Server: NS-1407.AWSDNS-47.ORG
#+end_src
** Debugging
   #+name: services currently hosted by google
   #+begin_src shell
      whois 35.189.36.228 | grep -i organization
   #+end_src

   #+RESULTS: services currently hosted by google
   #+begin_src shell
   Organization:   Google LLC (GOOGL-2)
   #+end_src
* Footnotes
** ingress
  #+begin_src tmate :session hh :window ingress
     # brew install helm
     helm repo add incubator http://storage.googleapis.com/kubernetes-charts-incubator
  #+end_src
  #+begin_src tmate :session hh :window ingress
     helm install incubator/aws-alb-ingress-controller --set autoDiscoverAwsRegion=true --set autoDiscoverAwsVpcID=true --set clusterName=apisnoop-prod alb-ingress
  #+end_src
** eks gitops
   #+begin_src tmate :session hh :window create
     export EKSCTL_EXPERIMENTAL=true
     eksctl \
         enable profile app-dev \
         --git-user "CNCF-CI" \
         --git-email cncf-ci@ii.coop \
         --git-url git@github.com:ii/apisnoop-deploy \
         --cluster apisnoop-prod \
         --region ap-southeast-2
   #+end_src
** helm
   #+begin_src shell
     helm install alb-ingress \
      incubator/aws-alb-ingress-controller \
      --set autoDiscoverAwsRegion=true \
      --set autoDiscoverAwsVpcID=true \
      --set clusterName=apisnoop-prod
   #+end_src
